<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plant Ops Area Check</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#0b0f1a;--panel:#0f172a;--muted:#9aa4b2;--text:#e6f0ff;--line:#192235;--ok:#16a34a;--y:#facc15;--o:#fb923c;--r:#ef4444;--w:#e5e7eb}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:18px 20px 28px}
    header{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:16px;padding:10px 12px;background:#10182b;border:1px solid var(--line);border-radius:16px}
    h1{margin:0;font-size:18px}
    .updated{font-size:13px;color:var(--muted);white-space:nowrap}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin:18px 0 14px}
    input[type=text]{background:#0b1324;color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px 12px;min-width:200px}
    button{background:#1b2745;color:var(--text);border:1px solid #263352;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:6px}
    .chipc{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(520px,1fr));gap:16px}
    .card{background:#0f172a;border:1px solid var(--line);border-radius:18px;padding:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .leftRow{display:flex;align-items:center;gap:10px}
    .title{font-size:18px;font-weight:800}
    .chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:10px;font-size:12px;font-weight:800;border:1px solid #2a3a5a}
    .pill.ok{background:rgba(22,163,74,.15);border-color:rgba(22,163,74,.4);color:#b7f7c7}
    .pill.attn{background:rgba(250,204,21,.15);border-color:rgba(250,204,21,.4);color:#fef9c3}
    .pill.alert{background:rgba(251,146,60,.15);border-color:rgba(251,146,60,.4);color:#ffedd5}
    .pill.crit{background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.4);color:#fecaca}
    .bodyRow{display:grid;grid-template-columns:220px 1fr 120px;gap:14px;align-items:center;margin-top:14px}
    .ringWrap{display:grid;justify-items:center}
    .ringLabel{font-size:12px;color:var(--muted);margin-top:6px}
    .ring{position:relative;width:200px;height:200px;border-radius:50%}
    .ring::before{content:"";position:absolute;inset:0;border-radius:50%;background:var(--gradient);z-index:0}
    .ring::after{content:"";position:absolute;inset:28px;border-radius:50%;background:#0f172a;border:1px solid var(--line);z-index:1}
    .ringVal{position:absolute;inset:0;display:grid;place-items:center;font-size:38px;font-weight:800;z-index:2;color:var(--valColor)}
    .kpis{display:grid;grid-template-columns:1fr;gap:12px}
    .kpi{background:#111c34;border:1px solid var(--line);border-radius:14px;padding:10px 12px}
    .kpi dt{font-size:12px;color:var(--muted)}
    .kpi dd{margin:4px 0 0 0;font-size:18px;font-weight:800}
    .subsV{margin:0;padding:0;list-style:none;display:grid;row-gap:6px}
    .subsV li{display:flex;justify-content:space-between}
    .risk{display:grid;justify-items:center;gap:6px}
    .riskBar{width:24px;height:120px;border-radius:14px;background:#0b1324;border:1px solid var(--line);position:relative;overflow:hidden}
    .riskFill{position:absolute;bottom:0;left:0;right:0;height:0;background:var(--riskColor)}
    .riskLabel{font-size:14px;font-weight:800}
    footer{margin-top:18px;color:var(--muted);font-size:12px;text-align:center}
    .btnLink{background:#0b1324;border:1px solid #263352;border-radius:10px;padding:8px 10px;font-size:12px;font-weight:700;cursor:pointer;color:#fff}
    .btnLink.outline{background:#111826;border:1px solid #3a4b6a}
    .btnRow{grid-column:1/3;display:flex;justify-content:space-between;gap:12px;margin-top:10px}
    .ticker{overflow:hidden;height:20px;position:relative;mask-image:linear-gradient(to right,transparent 0,black 24px,black calc(100% - 24px),transparent 100%);-webkit-mask-image:linear-gradient(to right,transparent 0,black 24px,black calc(100% - 24px),transparent 100%)}
    .tickerInner{white-space:nowrap;display:inline-block;padding-left:100%}
    @keyframes tickerScroll{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Plant Ops Area Check</h1>
      <div class="ticker"><div id="quoteTicker" class="tickerInner"></div></div>
      <div class="updated" id="updated">Loading</div>
    </header>

    <div class="controls">
      <button id="autoBtn">Auto discover areas</button>
      <input type="text" id="addArea" placeholder="Add area id">
      <button id="addBtn">Add</button>
      <button id="refreshBtn">Refresh</button>
      <button id="clearBtn">Clear list</button>
      <button onclick="location.href='leaderboard.html'">Leaderboard</button>
      <button onclick="location.href='archive.html'">Archive</button>
      <button onclick="location.href='issues.html'">Issues</button>
      <button onclick="location.href='eosr.html'">EOSR</button>
    </div>

    <div class="legend">
      <span class="chipc" style="background:var(--ok)"></span> good
      <span class="chipc" style="background:var(--y)"></span> caution
      <span class="chipc" style="background:var(--o)"></span> alert
      <span class="chipc" style="background:var(--r)"></span> critical
    </div>

    <div class="grid" id="grid"></div>
    <footer>ISSUES ring shows daily total by thresholds. Minutes since last check appears as a KPI. Header chips show on time and completion percent for the current plant day, 05:00 to 05:00 local.</footer>
  </div>

  <script>
    const API_SUM="/.netlify/functions/summary";
    const API_AREAS="/.netlify/functions/areas";
    const STORE="plantops-areas";
    const DEFAULTS=["KILL"];
    const REQUIRED_PER_SHIFT=7;

    const areaExcelLink={
      "PICKING":"https://waynefarms-my.sharepoint.com/:x:/p/dennis_barr/ETedCnjkWNlNneqVATRRlFcB8OMrM2I51p6Gt-r7ZkCowQ?email=Mickey.Cox%40WayneSanderson.com&e=4b43pU",
      "COOP":"https://waynefarms-my.sharepoint.com/:x:/p/dennis_barr/EeXKAhkkfv5Amp8dDE6mZIUB0EL9o0bTQzlbVQQkdolPRg?email=Mickey.Cox%40WayneSanderson.com&e=dKlT2N",
      "SCALD":"https://waynefarms-my.sharepoint.com/:x:/p/dennis_barr/EVm_b9dNLr5AraDYJFk8u38BloHekZ7iZZdSLwWXB76hnw?email=Mickey.Cox%40WayneSanderson.com&e=S9Pkhh",
      "KILL":"https://waynefarms-my.sharepoint.com/:x:/p/dennis_barr/EatqDhJEXGRGsj4Vp5ojd6gBGWJnEKpXvZB0MODCW91yMg?email=Mickey.Cox%40WayneSanderson.com&e=xmbZMV"
    };
    const areaSummaryLink={
      "PICKING":"https://forms.office.com/Pages/AnalysisPage.aspx?AnalyzerToken=oRRtSSCaPLoYsXPtPkYnttmjBPrVqLhn&id=3JG89IfD0E6e175TItrr8LO9tidJOFRAtBCVSjfTIJdUQzgwRVo0R0U4SEIwTzcyTFZCMFZLMVJMMy4u",
      "COOP":"https://forms.office.com/Pages/AnalysisPage.aspx?AnalyzerToken=JdnPgtc0TV4hcKiPB5bmKzFcvrJZZZkL&id=3JG89IfD0E6e175TItrr8LO9tidJOFRAtBCVSjfTIJdUNkYzSVNLRjc1SFQxUUNDWTQ5MEdVM1JZUi4u",
      "SCALD":"https://forms.office.com/Pages/AnalysisPage.aspx?AnalyzerToken=rK2kAcucVbPCMKSODJt5KGV6bCWHoL8Z&id=3JG89IfD0E6e175TItrr8LO9tidJOFRAtBCVSjfTIJdUMTZUVDExOVk3SFNOSzZVMk9NRVhJVUoyOC4u",
      "KILL":"https://forms.office.com/Pages/AnalysisPage.aspx?AnalyzerToken=G7m5c3T3FGDYURdfDQ8rO93KxjNb5H2K&id=3JG89IfD0E6e175TItrr8LO9tidJOFRAtBCVSjfTIJdUQlkwM0lFVDg0VVNBWUJRQjkwWVpKRUhCRi4u"
    };

    function uniq(a){return Array.from(new Set(a))}
    function loadAreas(){try{const s=localStorage.getItem(STORE);const arr=s?JSON.parse(s):DEFAULTS;return uniq(arr.map(v=>String(v||"").trim().toUpperCase()).filter(Boolean))}catch{return[...DEFAULTS]}}
    function saveAreas(a){localStorage.setItem(STORE,JSON.stringify(uniq(a)))}

    function formatNowChicago(){
      const f=new Intl.DateTimeFormat("en-US",{timeZone:"America/Chicago",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false,timeZoneName:"short"});
      const parts=Object.fromEntries(f.formatToParts(new Date()).map(p=>[p.type,p.value]));
      return `${parts.year}-${parts.month}-${parts.day} ${parts.hour}:${parts.minute}:${parts.second} ${parts.timeZoneName}`;
    }

    function fmt(iso){
      if(!iso)return"n/a";
      const d=new Date(iso);
      const p=n=>String(n).padStart(2,"0");
      return d.getUTCFullYear()+"-"+p(d.getUTCMonth()+1)+"-"+p(d.getUTCDate())+" "+p(d.getUTCHours())+":"+p(d.getUTCMinutes())+":"+p(d.getUTCSeconds())+" UTC";
    }

    function statusPill(s){const v=String(s||"").toUpperCase();if(v==="OK")return'<span class="pill ok">OK</span>';if(v==="ATTENTION")return'<span class="pill attn">Attention</span>';if(v==="ALERT")return'<span class="pill alert">Alert</span>';return'<span class="pill crit">Critical</span>'}
    function pctPill(label,pct){const n=Math.max(0,Math.min(100,Number(pct)||0));let cls="alert";if(n>=90)cls="ok";else if(n>=70)cls="attn";return`<span class="pill ${cls}">${label} ${n}%</span>`}
    function issuesTextColor(i){const n=Math.max(0,Number(i)||0);if(n===0)return"var(--ok)";if(n<=2)return"var(--y)";if(n<=4)return"var(--o)";return"var(--r)"}
    function ringGradientIssues(i){const n=Math.max(0,Number(i)||0);if(n===0)return"conic-gradient(var(--ok) 360deg, transparent 0)";const cap=Math.min(n,15);const deg=v=>Math.round((v/15)*360);const yEnd=deg(Math.min(cap,6));const oEnd=deg(Math.min(cap,10));const rEnd=deg(cap);const parts=[];if(yEnd>0)parts.push(`var(--y) ${yEnd}deg`);if(oEnd>yEnd)parts.push(`var(--o) ${oEnd}deg`);if(rEnd>oEnd)parts.push(`var(--r) ${rEnd}deg`);parts.push("rgba(255,255,255,0.06) 0");return`conic-gradient(${parts.join(",")})`}
    function issuesRing(i){const gradient=ringGradientIssues(i);const color=issuesTextColor(i);return `<div class="ringWrap"><div class="ring" style="--gradient:${gradient}"><div class="ringVal" style="color:${color}">${Math.max(0,Number(i)||0)}</div></div><div class="ringLabel">ISSUES</div></div>`}
    function riskColor(i){if(i>=5)return"var(--r)";if(i>=3)return"var(--o)";if(i>=1)return"var(--y)";return"var(--ok)"}
    function riskLabel(i){if(i>=5)return"Critical";if(i>=3)return"Alert";if(i>=1)return"Attention";return"Good"}
    function riskFillTier(i){if(i>=5)return 100; if(i>=3)return 75; if(i>=1)return 50; return 25}
    function shiftColor(n){if(n>=9)return"var(--w)";if(n>=7)return"var(--ok)";if(n>=5)return"var(--o)";if(n>=3)return"var(--o)";return"var(--r)"}
    function subsStack(f,s,t){return `<ul class="subsV"><li><span>1st</span><span style="color:${shiftColor(f)}">${f}</span></li><li><span>2nd</span><span style="color:${shiftColor(s)}">${s}</span></li><li><span>3rd</span><span style="color:${shiftColor(t)}">${t}</span></li></ul>`}
    function resolveAreaKey(area){const a=String(area||"").toUpperCase();if(a.startsWith("PICK"))return"PICKING";return a;}

    function currentShiftChicago(){
      const z="America/Chicago";
      const d=new Date();
      const fmt=new Intl.DateTimeFormat("en-US",{timeZone:z,hour:"2-digit",hour12:false});
      const hour=parseInt(fmt.format(d),10);
      if(hour>=5 && hour<13) return "first";
      if(hour>=13 && hour<21) return "second";
      return "third";
    }

    function card(area,d){
      const minutes=Math.max(0,Number(d.minutesSince)||0);
      const f=Number(d.shiftCountsToday?.first||0);
      const s=Number(d.shiftCountsToday?.second||0);
      const t=Number(d.shiftCountsToday?.third||0);
      const submissions=(Number(d.submissionsToday??0))||(f+s+t);
      const active=currentShiftChicago();
      const counts={first:f,second:s,third:t};
      const compLocal=Math.round(Math.min(100,Math.max(0,(counts[active]/Math.max(1,REQUIRED_PER_SHIFT))*100)));
      const rColor=riskColor(d.issuesToday);
      const rPct=riskFillTier(d.issuesToday);
      const chips=[pctPill("On time",d.onTimePct),pctPill("Completions",compLocal),statusPill(d.status)].join("");
      const key=resolveAreaKey(area);
      const hasExcel=!!areaExcelLink[key];
      const hasSummary=!!areaSummaryLink[key];
      const btnRow=(hasExcel||hasSummary)?`<div class="btnRow">${hasExcel?`<button class="btnLink" onclick="openExcel('${key}')">Open Excel</button>`:""}${hasSummary?`<button class="btnLink outline" onclick="openSummary('${key}')">View Summary</button>`:""}</div>`:"";
      return `<div class="card">
        <div class="row"><div class="leftRow"><span class="title">${area}</span></div><div class="chips">${chips}</div></div>
        <div class="bodyRow">
          ${issuesRing(d.issuesToday)}
          <div class="kpis">
            <div class="kpi"><dt>Minutes since last check</dt><dd>${minutes} minutes</dd></div>
            <div class="kpi"><dt>Today submissions</dt><dd>${submissions}</dd></div>
            <div class="kpi"><dt>Shift submittals today</dt><dd>${subsStack(f,s,t)}</dd></div>
            <div class="kpi"><dt>Last time</dt><dd>${fmt(d.lastTime)}</dd></div>
          </div>
          <div class="risk">
            <div class="riskBar"><div class="riskFill" style="height:${rPct}%;background:${rColor}"></div></div>
            <div class="riskLabel" style="color:${rColor}">${riskLabel(d.issuesToday)}</div>
          </div>
          ${btnRow}
        </div>
      </div>`;
    }

    async function fetchSummary(a){const r=await fetch(API_SUM+"?area="+encodeURIComponent(a),{cache:"no-store"});if(!r.ok)throw new Error("HTTP "+r.status);return r.json()}
    async function fetchAreas(){const r=await fetch(API_AREAS,{cache:"no-store"});if(!r.ok)throw new Error("HTTP "+r.status);const j=await r.json();return Array.isArray(j.areas)?j.areas:[]}

    async function render(){
      const c=document.getElementById("grid");
      const areas=loadAreas();
      if(!areas.length){c.innerHTML="";document.getElementById("updated").textContent="Updated: "+formatNowChicago();return;}
      const results=await Promise.allSettled(areas.map(fetchSummary));
      c.innerHTML=results.map((r,i)=>{const a=areas[i];if(r.status==="fulfilled")return card(a,r.value);return `<div class="card"><div class="row"><span class="title">${a}</span><span class="pill crit">Error</span></div></div>`}).join("");
      document.getElementById("updated").textContent="Updated: "+formatNowChicago();
    }

    async function autoDiscover(){try{const discovered=await fetchAreas();if(discovered.length){saveAreas(discovered);await render()}}catch{}}
    function addArea(){const input=document.getElementById("addArea");const val=input.value.trim().toUpperCase();if(!val)return;const areas=loadAreas();if(!areas.includes(val)){areas.push(val);saveAreas(areas);render()}input.value="";input.focus()}
    function openExcel(area){const url=areaExcelLink[String(area||"").toUpperCase()];if(!url){alert("No Excel link set for "+area);return;}window.open(url,"_blank","noopener,noreferrer")}
    function openSummary(area){const url=areaSummaryLink[String(area||"").toUpperCase()];if(!url){alert("No Summary link set for "+area);return;}window.open(url,"_blank","noopener,noreferrer")}

    document.getElementById("autoBtn").addEventListener("click",()=>autoDiscover());
    document.getElementById("addBtn").addEventListener("click",addArea);
    document.getElementById("addArea").addEventListener("keydown",e=>{if(e.key==="Enter")addArea()});
    document.getElementById("refreshBtn").addEventListener("click",()=>render());
    document.getElementById("clearBtn").addEventListener("click",()=>{saveAreas(["KILL"]);render()});

    const QUOTES_TICKER=[
      "Best plant day, every day.",
      "Safety first. Quality always.",
      "Small fixes today prevent big problems tomorrow.",
      "If it’s not written down, it didn’t happen.",
      "We don’t find time, we make time."
    ];
    function runQuoteTicker(elId){
      const el=document.getElementById(elId);
      if(!el) return;
      let i=0;
      function next(){
        const text=QUOTES_TICKER[i%QUOTES_TICKER.length];
        i++;
        el.innerHTML=`<span>${text}</span>`;
        const span=el.firstElementChild;
        requestAnimationFrame(()=>{
          const total=span.offsetWidth+el.offsetWidth;
          const seconds=Math.min(20,Math.max(8,total/60));
          el.style.animation=`tickerScroll ${seconds}s linear`;
        });
      }
      el.addEventListener("animationend",()=>{
        el.style.animation="none";
        void el.offsetWidth;
        next();
      });
      next();
    }
    runQuoteTicker("quoteTicker");

    autoDiscover().then(render);
  </script>
</body>
</html>
