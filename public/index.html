<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plant Ops Area Check</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --ok:#16a34a; --attn:#dc2626; --card:#111827; --bg:#0b1220; --text:#e5e7eb; --muted:#9ca3af; }
    * { box-sizing: border-box; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header { padding:16px 20px; border-bottom:1px solid #1f2937; display:flex; align-items:center; justify-content:space-between; }
    header h1 { font-size:20px; margin:0; }
    .right { font-size:14px; color:var(--muted); }
    main { padding:20px; max-width:1000px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:16px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .area { font-size:18px; font-weight:600; letter-spacing:0.5px; }
    .badge { padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .ok { background:rgba(22,163,74,0.15); color:#bbf7d0; border:1px solid rgba(22,163,74,0.5); }
    .attn { background:rgba(220,38,38,0.15); color:#fecaca; border:1px solid rgba(220,38,38,0.5); }
    dl { margin:14px 0 0 0; display:grid; grid-template-columns: 1fr 1fr; gap:10px 14px; }
    dt { color:var(--muted); font-size:12px; }
    dd { margin:0; font-size:14px; }
    footer { padding:14px 20px; color:var(--muted); font-size:12px; border-top:1px solid #1f2937; text-align:center; }
    .controls { display:flex; gap:8px; margin-bottom:16px; }
    button { background:#1f2937; color:var(--text); border:1px solid #374151; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer; }
    button:hover { filter:brightness(1.1); }
    input[type=text] { background:#0f172a; color:var(--text); border:1px solid #1f2937; border-radius:10px; padding:8px 10px; min-width:140px; }
  </style>
</head>
<body>
  <header>
    <h1>Plant Ops Area Check</h1>
    <div class="right" id="updated">Loading</div>
  </header>
  <main>
    <div class="controls">
      <input type="text" id="addArea" placeholder="Add area id">
      <button id="addBtn">Add</button>
      <button id="refreshBtn">Refresh</button>
      <button id="clearBtn">Clear list</button>
    </div>
    <div class="grid" id="grid"></div>
  </main>
  <footer>
    Status uses latest record for each area, issuesToday is the daily sum.
  </footer>

  <script>
    const API_BASE = "https://plantopsareacheck.netlify.app/.netlify/functions";
    const DEFAULT_AREAS = ["KILL"];
    const STORE_KEY = "plantops-areas";

    function loadAreas() {
      try {
        const raw = localStorage.getItem(STORE_KEY);
        if (!raw) return [...DEFAULT_AREAS];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr) || arr.length === 0) return [...DEFAULT_AREAS];
        return arr.map(s => String(s).toUpperCase());
      } catch { return [...DEFAULT_AREAS]; }
    }

    function saveAreas(areas) {
      localStorage.setItem(STORE_KEY, JSON.stringify(areas));
    }

    function fmtTime(iso) {
      if (!iso) return "n/a";
      try {
        const d = new Date(iso);
        const pad = n => String(n).padStart(2,"0");
        return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) + " " + pad(d.getHours()) + ":" + pad(d.getMinutes()) + ":" + pad(d.getSeconds()) + " UTC";
      } catch { return iso; }
    }

    function badge(status) {
      const ok = String(status).toUpperCase() === "OK";
      const cls = ok ? "badge ok" : "badge attn";
      return `<span class="${cls}">${ok ? "OK" : "Attention"}</span>`;
    }

    function card(area, data) {
      return `
        <div class="card" data-area="${area}">
          <div class="row">
            <div class="area">${area}</div>
            <div>${badge(data.status)}</div>
          </div>
          <dl>
            <dt>Issues today</dt><dd>${Number(data.issuesToday ?? 0)}</dd>
            <dt>Last time</dt><dd>${fmtTime(data.lastTime)}</dd>
            <dt>Minutes since</dt><dd>${Number(data.minutesSince ?? 0)}</dd>
            <dt>Status</dt><dd>${data.status}</dd>
          </dl>
        </div>
      `;
    }

    async function fetchArea(area) {
      const url = `${API_BASE}/summary?area=${encodeURIComponent(area)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    async function render() {
      const grid = document.getElementById("grid");
      const areas = loadAreas();
      const results = await Promise.allSettled(areas.map(a => fetchArea(a)));
      grid.innerHTML = results.map((r, i) => {
        const area = areas[i];
        if (r.status === "fulfilled") return card(area, r.value);
        return `
          <div class="card">
            <div class="row">
              <div class="area">${area}</div>
              <div class="badge attn">Error</div>
            </div>
            <dl>
              <dt>Message</dt><dd>${r.reason && r.reason.message ? r.reason.message : "Load failed"}</dd>
              <dt>Suggestion</dt><dd>Check area id or try refresh</dd>
            </dl>
          </div>
        `;
      }).join("");
      document.getElementById("updated").textContent = "Updated: " + fmtTime(new Date().toISOString());
    }

    function addAreaFromInput() {
      const inp = document.getElementById("addArea");
      const val = inp.value.trim().toUpperCase();
      if (!val) return;
      const areas = loadAreas();
      if (!areas.includes(val)) {
        areas.push(val);
        saveAreas(areas);
        render().catch(()=>{});
      }
      inp.value = "";
      inp.focus();
    }

    document.getElementById("addBtn").addEventListener("click", addAreaFromInput);
    document.getElementById("addArea").addEventListener("keydown", e => { if (e.key === "Enter") addAreaFromInput(); });
    document.getElementById("refreshBtn").addEventListener("click", () => render().catch(()=>{}));
    document.getElementById("clearBtn").addEventListener("click", () => { saveAreas([...DEFAULT_AREAS]); render().catch(()=>{}); });

    render().catch(()=>{});
    setInterval(() => render().catch(()=>{}), 30000);
  </script>
</body>
</html>
